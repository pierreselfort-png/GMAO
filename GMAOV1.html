<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GMAO ‚Äì HTML (Local)</title>
  <style>
    :root{
      --bg:#f3f5f9;
      --panel:#1f2937;
      --panel2:#273141;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#6b7280;
      --good:#86efac;
      --warn:#fed7aa;
      --bad:#fca5a5;
      --chip:#f1f5f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    .app{min-height:100vh;display:flex;flex-direction:column}
    header{
      position:sticky;top:0;z-index:5;
      background:linear-gradient(180deg, #1f2937, #1f2937);
      border-bottom:1px solid #111827;
      backdrop-filter: blur(10px);
    }
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:radial-gradient(circle at 30% 30%, #93c5fd, #1d4ed8 60%, #0b1220);
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 10px 30px rgba(0,0,0,0.35);
    }
    h1{font-size:16px;margin:0;font-weight:650;letter-spacing:0.2px;color:#f9fafb}
    .subtitle{font-size:12px;color:#cbd5f5;margin-top:2px}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:#f8fafc;
      color:#111827;
      padding:8px 10px;border-radius:12px;
      cursor:pointer;font-size:12px;
      box-shadow:0 1px 2px rgba(15,23,42,0.12);
    }
    .btn:hover{border-color:#cbd5e1}
    .btn.primary{background:#4b5563;border-color:#4b5563;color:#f9fafb}
    .btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .tabs{
      display:flex;gap:6px;flex-wrap:wrap;
      padding:0 12px 12px 12px;
    }
    .tab{
      border:1px solid transparent;
      background:rgba(255,255,255,0.12);
      padding:8px 10px;border-radius:999px;
      cursor:pointer;font-size:12px;color:#d1d5db;
    }
    .tab.active{color:#111827;border-color:#e5e7eb;background:#e5e7eb}
    main{padding:16px;max-width:1200px;width:100%;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.1fr 1.9fr;gap:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .grid.dashboard{grid-template-columns:1fr}
    .card{
      background:var(--card);
      border:1px solid #e5e7eb;
      border-radius:18px;
      box-shadow:0 6px 18px rgba(15,23,42,0.08);
      overflow:hidden;
    }
    .cardHeader{padding:14px 14px 10px 14px;border-bottom:1px solid #e5e7eb}
    .cardTitle{margin:0;font-size:13px;font-weight:650}
    .cardBody{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:170px;margin-bottom:10px}
    label{font-size:11px;color:var(--muted)}
    input, textarea, select{
      width:100%;
      background:#ffffff;
      border:1px solid #e5e7eb;
      color:#111827;
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:86px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:#94a3b8}
    .hint{font-size:11px;color:var(--muted);margin-top:-4px}
    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th, td{padding:10px 10px;border-bottom:1px solid #e5e7eb;vertical-align:top;font-size:12px}
    th{position:sticky;top:0;background:#f8fafc;backdrop-filter:blur(6px);text-align:left;color:#6b7280;font-weight:600;z-index:1}
    tr:hover td{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#f8fafc;border:1px solid #e5e7eb;font-size:11px;color:#4b5563}
    .dot{width:8px;height:8px;border-radius:999px;background:#9ca3af}
    .dot.good{background:#86efac}
    .dot.warn{background:#fcd34d}
    .dot.bad{background:#fca5a5}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
    .search{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search input{min-width:260px}
    .tiny{font-size:11px;color:var(--muted)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .pill{background:#f8fafc}
    .rightBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:50;
      background:#ffffff;
      border:1px solid #e5e7eb;
      padding:10px 12px;border-radius:14px;max-width:360px;
      box-shadow:0 18px 40px rgba(15,23,42,0.15);
      display:none;
      font-size:12px;color:#111827;
    }
    .toast.show{display:block}
    .toast .muted{color:var(--muted);font-size:11px;margin-top:2px}
    .footer{padding:16px;color:var(--muted);font-size:11px;text-align:center}
    .dangerText{color:rgba(239,68,68,0.95)}
    .dashboardGrid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px}
    @media (max-width: 980px){.dashboardGrid{grid-template-columns:1fr}}
    .dashboardCard{background:#ffffff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;box-shadow:0 6px 16px rgba(15,23,42,0.08)}
    .dashboardCard h3{margin:0 0 8px 0;font-size:13px}
    .dashboardList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    .dashboardList li{padding:8px;border-radius:12px;background:#f8fafc;border:1px solid #e5e7eb;font-size:12px}
    .dashboardEmpty{color:var(--muted);font-size:12px}
  </style>
</head>

<body>
<div class="app">

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>GMAO ‚Äì Local (HTML)</h1>
          <div class="subtitle">Stocks ‚Ä¢ Fournisseurs ‚Ä¢ Machines ‚Ä¢ Interventions ‚Ä¢ Tickets</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnExport">Exporter JSON</button>
        <label class="btn" for="importFile" style="cursor:pointer">Importer JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button class="btn danger" id="btnReset">Reset (tout effacer)</button>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>
  </header>

  <main>
    <div class="grid" id="mainGrid">
      <!-- Form -->
      <section class="card" id="formCard">
        <div class="cardHeader">
          <h2 class="cardTitle" id="formTitle">‚Äî</h2>
        </div>
        <div class="cardBody" id="formArea"></div>
      </section>

      <!-- List -->
      <section class="card">
        <div class="cardHeader">
          <h2 class="cardTitle" id="listTitle">‚Äî</h2>
        </div>
        <div class="cardBody">
          <div id="listArea">
            <div class="toolbar">
              <div class="search">
                <input id="searchInput" placeholder="Rechercher‚Ä¶" />
                <span class="tiny" id="countLabel">0 √©l√©ments</span>
              </div>
              <div class="rightBtns">
                <button class="btn" id="btnNew">Nouveau</button>
              </div>
            </div>

            <div class="kpi" id="kpis"></div>

            <div class="tableWrap" style="margin-top:10px">
              <table>
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <div class="tiny" style="margin-top:10px">
              Astuce : clique sur une ligne pour <b>√©diter</b>. Le bouton üóëÔ∏è supprime.
            </div>
          </div>
          <div id="dashboardArea" style="display:none"></div>
        </div>
      </section>
    </div>

    <div class="footer">
      Donn√©es stock√©es en <b>localStorage</b>. Pour partager entre plusieurs postes : Google Sheet / serveur / base.
    </div>
  </main>

  <div class="toast" id="toast"></div>
</div>

<script>
/* ============================
   0) Utils
============================ */
const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + Date.now()));
const nowISO = () => new Date().toISOString().slice(0,16); // yyyy-mm-ddThh:mm
const fmt = (s) => (s ?? "").toString().trim();
const safeInt = (v, def=0) => {
  const n = parseInt(v, 10);
  return Number.isFinite(n) ? n : def;
};
function toast(msg, sub=""){
  const t = document.getElementById("toast");
  t.innerHTML = `<div>${msg}</div>${sub ? `<div class="muted">${sub}</div>` : ""}`;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2600);
}
function confirmDanger(message){
  return window.confirm(message);
}

/* ============================
   1) Data model + storage
============================ */
const DB_KEY = "GMAO_LOCAL_V1";

const defaultDB = () => ({
  fournisseurs: [
    { id: uid(), entreprise:"ACME Industrie", nomContact:"Mme Dupont", tel:"0600000000", mail:"contact@acme.fr" },
  ],
  machines: [
    { id: uid(), numeroUnique:"M-001", nom:"Presse Hydraulique", lieu:"Atelier A", etat:"ok", fournisseurId:"", documentation:"" }
  ],
  stocks: [
    { id: uid(), reference:"REF-1001", quantite:12, nom:"Courroie", description:"Courroie de transmission", stockSecu:5, machineId:"", fournisseurId:"" }
  ],
  interventions: [
    { id: uid(), numero:"INT-0001", technicien:"Pierre", nom:"Contr√¥le niveau huile", description:"V√©rifier le niveau + appoint", date: nowISO(), statut:"a_planifier", importance:"moyen", machineId:"" }
  ],
  tickets: [
    { id: uid(), numero:"TIC-0001", demandeur:"Production", sujet:"Bruit anormal", description:"Bruit c√¥t√© moteur", dateCreation: nowISO(), statut:"ouvert", importance:"haut", machineId:"", lienInterventionId:"" }
  ]
});

function loadDB(){
  try{
    const raw = localStorage.getItem(DB_KEY);
    if(!raw) return defaultDB();
    const parsed = JSON.parse(raw);
    // garde-fou minimal
    return {
      fournisseurs: Array.isArray(parsed.fournisseurs) ? parsed.fournisseurs : [],
      machines: Array.isArray(parsed.machines) ? parsed.machines : [],
      stocks: Array.isArray(parsed.stocks) ? parsed.stocks : [],
      interventions: Array.isArray(parsed.interventions) ? parsed.interventions : [],
      tickets: Array.isArray(parsed.tickets) ? parsed.tickets : [],
    };
  }catch(e){
    console.error(e);
    return defaultDB();
  }
}
function saveDB(){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}
let db = loadDB();

/* ============================
   2) Entity config (fields, table columns)
============================ */
const ENTITIES = {
  dashboard: {
    label: "Dashboard"
  },
  stocks: {
    label: "Stocks",
    pk: "id",
    fields: [
      { key:"reference", label:"R√©f√©rence", type:"text", required:true, placeholder:"ex: REF-1234" },
      { key:"quantite", label:"Quantit√©", type:"number", required:true, placeholder:"0" },
      { key:"nom", label:"Nom", type:"text", required:true, placeholder:"ex: Roulement 6203" },
      { key:"description", label:"Description", type:"textarea", required:false, placeholder:"D√©tails de la pi√®ce‚Ä¶" },
      { key:"stockSecu", label:"Stock de s√©curit√©", type:"number", required:true, placeholder:"0" },
      { key:"machineId", label:"Machine associ√©e", type:"select_machine", required:false },
      { key:"fournisseurId", label:"Fournisseur", type:"select_fournisseur", required:false },
    ],
    columns: [
      { key:"reference", label:"R√©f√©rence" },
      { key:"nom", label:"Nom" },
      { key:"quantite", label:"Qt√©" },
      { key:"stockSecu", label:"Stock s√©cu" },
      { key:"machineId", label:"Machine" , render: (v)=> nameById("machines", v, "nom", "‚Äî") },
      { key:"fournisseurId", label:"Fournisseur", render: (v)=> nameById("fournisseurs", v, "entreprise", "‚Äî") },
      { key:"_alert", label:"Alerte", render: (_, row)=> stockAlertPill(row) },
    ],
    kpis: () => {
      const totalRefs = db.stocks.length;
      const low = db.stocks.filter(s => safeInt(s.quantite) <= safeInt(s.stockSecu)).length;
      return [
        { text:`${totalRefs} pi√®ces`, dot:"" },
        { text:`${low} sous le stock s√©cu`, dot: low>0 ? "warn" : "good" }
      ];
    }
  },

  fournisseurs: {
    label: "Fournisseurs",
    pk: "id",
    fields: [
      { key:"entreprise", label:"Entreprise", type:"text", required:true, placeholder:"ex: Trigano Supplies" },
      { key:"nomContact", label:"Nom contact", type:"text", required:true, placeholder:"ex: M. Martin" },
      { key:"tel", label:"Num√©ro", type:"tel", required:false, placeholder:"ex: 06‚Ä¶" },
      { key:"mail", label:"Mail", type:"email", required:false, placeholder:"ex: martin@‚Ä¶" },
    ],
    columns: [
      { key:"entreprise", label:"Entreprise" },
      { key:"nomContact", label:"Contact" },
      { key:"tel", label:"T√©l√©phone" },
      { key:"mail", label:"Email" },
    ],
    kpis: () => [{ text:`${db.fournisseurs.length} fournisseurs`, dot:"" }]
  },

  machines: {
    label: "Machines",
    pk: "id",
    fields: [
      { key:"numeroUnique", label:"N¬∞ unique machine", type:"text", required:true, placeholder:"ex: M-002" },
      { key:"nom", label:"Nom machine", type:"text", required:true, placeholder:"ex: Convoyeur 3" },
      { key:"lieu", label:"Lieu de stockage", type:"text", required:false, placeholder:"ex: Atelier B" },
      { key:"etat", label:"√âtat", type:"select", required:true, options:[
        {value:"ok", label:"OK"},
        {value:"hs", label:"HS"},
        {value:"en_reparation", label:"En r√©paration"},
      ]},
      { key:"fournisseurId", label:"Fournisseur", type:"select_fournisseur", required:false },
      { key:"documentation", label:"Documentation (lien)", type:"url", required:false, placeholder:"https://‚Ä¶" },
    ],
    columns: [
      { key:"numeroUnique", label:"N¬∞" },
      { key:"nom", label:"Machine" },
      { key:"lieu", label:"Lieu" },
      { key:"etat", label:"√âtat", render:(v)=> etatPill(v) },
      { key:"fournisseurId", label:"Fournisseur", render:(v)=> nameById("fournisseurs", v, "entreprise", "‚Äî") },
      { key:"documentation", label:"Doc", render:(v)=> v ? `<a href="${escapeAttr(v)}" target="_blank">Ouvrir</a>` : "‚Äî" },
    ],
    kpis: () => {
      const hs = db.machines.filter(m => m.etat==="hs").length;
      const rep = db.machines.filter(m => m.etat==="en_reparation").length;
      return [
        { text:`${db.machines.length} machines`, dot:"" },
        { text:`${hs} HS`, dot: hs>0 ? "bad":"good" },
        { text:`${rep} en r√©paration`, dot: rep>0 ? "warn":"good" },
      ];
    }
  },

  interventions: {
    label: "Interventions",
    pk: "id",
    fields: [
      { key:"numero", label:"N¬∞ d'intervention", type:"text", required:true, placeholder:"ex: INT-0002" },
      { key:"technicien", label:"Technicien", type:"text", required:true, placeholder:"ex: Alex" },
      { key:"nom", label:"Nom intervention", type:"text", required:true, placeholder:"ex: Remplacement filtre" },
      { key:"description", label:"Description", type:"textarea", required:false, placeholder:"D√©tails‚Ä¶" },
      { key:"date", label:"Date", type:"datetime-local", required:true },
      { key:"statut", label:"Statut", type:"select", required:true, options:[
        {value:"a_planifier", label:"√Ä planifier"},
        {value:"planifie", label:"Planifi√©"},
        {value:"en_cours", label:"En cours"},
        {value:"termine", label:"Termin√©"},
        {value:"annule", label:"Annul√©"},
      ]},
      { key:"importance", label:"Niveau d'importance", type:"select", required:true, options:[
        {value:"bas", label:"Bas"},
        {value:"moyen", label:"Moyen"},
        {value:"haut", label:"Haut"},
        {value:"critique", label:"Critique"},
      ]},
      { key:"machineId", label:"Machine", type:"select_machine", required:false },
    ],
    columns: [
      { key:"numero", label:"N¬∞" },
      { key:"nom", label:"Intervention" },
      { key:"technicien", label:"Technicien" },
      { key:"date", label:"Date", render:(v)=> v ? new Date(v).toLocaleString() : "‚Äî" },
      { key:"statut", label:"Statut", render:(v)=> statutPill(v) },
      { key:"importance", label:"Importance", render:(v)=> importancePill(v) },
      { key:"machineId", label:"Machine", render:(v)=> nameById("machines", v, "nom", "‚Äî") },
    ],
    kpis: () => {
      const open = db.interventions.filter(i => i.statut!=="termine" && i.statut!=="annule").length;
      return [
        { text:`${db.interventions.length} interventions`, dot:"" },
        { text:`${open} en cours / √† faire`, dot: open>0 ? "warn":"good" },
      ];
    }
  },

  tickets: {
    label: "Tickets",
    pk: "id",
    fields: [
      { key:"numero", label:"N¬∞ ticket", type:"text", required:true, placeholder:"ex: TIC-0002" },
      { key:"demandeur", label:"Demandeur", type:"text", required:true, placeholder:"ex: Production" },
      { key:"sujet", label:"Sujet", type:"text", required:true, placeholder:"ex: Fuite d'air" },
      { key:"description", label:"Description", type:"textarea", required:false, placeholder:"Contexte‚Ä¶" },
      { key:"dateCreation", label:"Date cr√©ation", type:"datetime-local", required:true },
      { key:"statut", label:"Statut", type:"select", required:true, options:[
        {value:"ouvert", label:"Ouvert"},
        {value:"en_traitement", label:"En traitement"},
        {value:"clos", label:"Clos"},
      ]},
      { key:"importance", label:"Importance", type:"select", required:true, options:[
        {value:"bas", label:"Bas"},
        {value:"moyen", label:"Moyen"},
        {value:"haut", label:"Haut"},
        {value:"critique", label:"Critique"},
      ]},
      { key:"machineId", label:"Machine", type:"select_machine", required:false },
      // action sp√©ciale
      { key:"_createIntervention", label:"Cr√©er une intervention √† partir du ticket", type:"action_create_intervention" }
    ],
    columns: [
      { key:"numero", label:"N¬∞" },
      { key:"sujet", label:"Sujet" },
      { key:"demandeur", label:"Demandeur" },
      { key:"dateCreation", label:"Cr√©√©", render:(v)=> v ? new Date(v).toLocaleString() : "‚Äî" },
      { key:"statut", label:"Statut", render:(v)=> ticketStatutPill(v) },
      { key:"importance", label:"Importance", render:(v)=> importancePill(v) },
      { key:"machineId", label:"Machine", render:(v)=> nameById("machines", v, "nom", "‚Äî") },
      { key:"lienInterventionId", label:"Intervention", render:(v)=> v ? linkToIntervention(v) : "‚Äî" },
    ],
    kpis: () => {
      const open = db.tickets.filter(t => t.statut!=="clos").length;
      return [
        { text:`${db.tickets.length} tickets`, dot:"" },
        { text:`${open} ouverts`, dot: open>0 ? "warn":"good" }
      ];
    }
  }
};

function escapeAttr(str){
  return (str ?? "").toString().replaceAll('"', "&quot;");
}
function nameById(entityKey, id, field="nom", fallback="‚Äî"){
  const x = db[entityKey].find(r => r.id === id);
  return x ? (x[field] || fallback) : fallback;
}

/* ============================
   3) Pills / render helpers
============================ */
function etatPill(etat){
  const map = {
    ok: {t:"OK", d:"good"},
    hs: {t:"HS", d:"bad"},
    en_reparation: {t:"En r√©paration", d:"warn"}
  };
  const it = map[etat] || {t: etat || "‚Äî", d:""};
  return `<span class="pill"><span class="dot ${it.d}"></span>${it.t}</span>`;
}
function statutPill(s){
  const map = {
    a_planifier:{t:"√Ä planifier", d:"warn"},
    planifie:{t:"Planifi√©", d:"good"},
    en_cours:{t:"En cours", d:"warn"},
    termine:{t:"Termin√©", d:"good"},
    annule:{t:"Annul√©", d:"bad"},
  };
  const it = map[s] || {t:s||"‚Äî", d:""};
  return `<span class="pill"><span class="dot ${it.d}"></span>${it.t}</span>`;
}
function ticketStatutPill(s){
  const map = {
    ouvert:{t:"Ouvert", d:"warn"},
    en_traitement:{t:"En traitement", d:"warn"},
    clos:{t:"Clos", d:"good"},
  };
  const it = map[s] || {t:s||"‚Äî", d:""};
  return `<span class="pill"><span class="dot ${it.d}"></span>${it.t}</span>`;
}
function importancePill(i){
  const map = {
    bas:{t:"Bas", d:"good"},
    moyen:{t:"Moyen", d:"warn"},
    haut:{t:"Haut", d:"warn"},
    critique:{t:"Critique", d:"bad"},
  };
  const it = map[i] || {t:i||"‚Äî", d:""};
  return `<span class="pill"><span class="dot ${it.d}"></span>${it.t}</span>`;
}
function stockAlertPill(row){
  const q = safeInt(row.quantite);
  const s = safeInt(row.stockSecu);
  if(q <= s){
    return `<span class="pill"><span class="dot warn"></span>Bas (${q} ‚â§ ${s})</span>`;
  }
  return `<span class="pill"><span class="dot good"></span>OK</span>`;
}
function linkToIntervention(interventionId){
  const it = db.interventions.find(i => i.id===interventionId);
  if(!it) return "‚Äî";
  return `<span class="pill"><span class="dot good"></span>${it.numero}</span>`;
}

/* ============================
   4) UI state
============================ */
let currentEntity = "dashboard";
let editingId = null;

const tabsEl = document.getElementById("tabs");
const formTitle = document.getElementById("formTitle");
const listTitle = document.getElementById("listTitle");
const formArea = document.getElementById("formArea");
const thead = document.getElementById("thead");
const tbody = document.getElementById("tbody");
const searchInput = document.getElementById("searchInput");
const countLabel = document.getElementById("countLabel");
const kpisEl = document.getElementById("kpis");
const formCard = document.getElementById("formCard");
const listArea = document.getElementById("listArea");
const dashboardArea = document.getElementById("dashboardArea");
const mainGrid = document.getElementById("mainGrid");

function initTabs(){
  tabsEl.innerHTML = "";
  Object.entries(ENTITIES).forEach(([key, cfg])=>{
    const b = document.createElement("button");
    b.className = "tab" + (key===currentEntity ? " active" : "");
    b.textContent = cfg.label;
    b.onclick = ()=> switchEntity(key);
    tabsEl.appendChild(b);
  });
}

function switchEntity(key){
  currentEntity = key;
  editingId = null;
  searchInput.value = "";
  initTabs();
  render();
}

function render(){
  const cfg = ENTITIES[currentEntity];
  if(currentEntity === "dashboard"){
    formCard.style.display = "none";
    listArea.style.display = "none";
    dashboardArea.style.display = "block";
    mainGrid.classList.add("dashboard");
    listTitle.textContent = "Dashboard ‚Äì Vue d‚Äôensemble";
    renderDashboard();
  }else{
    formCard.style.display = "";
    listArea.style.display = "block";
    dashboardArea.style.display = "none";
    mainGrid.classList.remove("dashboard");
    formTitle.textContent = editingId ? `√âditer ‚Äì ${cfg.label}` : `Cr√©er ‚Äì ${cfg.label}`;
    listTitle.textContent = `Liste ‚Äì ${cfg.label}`;
    renderForm();
    renderTable();
    renderKPIs();
  }
}

function renderKPIs(){
  const cfg = ENTITIES[currentEntity];
  const items = cfg.kpis ? cfg.kpis() : [];
  kpisEl.innerHTML = items.map(it=>{
    return `<span class="pill">${it.dot ? `<span class="dot ${it.dot}"></span>`:""}${it.text}</span>`;
  }).join("");
}

function renderDashboard(){
  const now = new Date();
  const limit = new Date();
  limit.setDate(now.getDate() + 14);

  const lowStocks = db.stocks.filter(s => safeInt(s.quantite) <= safeInt(s.stockSecu));
  const openTickets = db.tickets.filter(t => t.statut !== "clos");
  const upcomingInterventions = db.interventions.filter(i => {
    if(i.statut !== "planifie") return false;
    if(!i.date) return false;
    const d = new Date(i.date);
    return d >= now && d <= limit;
  });
  const machinesRepair = db.machines.filter(m => m.etat === "en_reparation");

  dashboardArea.innerHTML = `
    <div class="dashboardGrid">
      <div class="dashboardCard">
        <h3>Pi√®ces sous stock de s√©curit√©</h3>
        ${lowStocks.length ? `
          <ul class="dashboardList">
            ${lowStocks.map(item => `
              <li>
                <strong>${escapeHTML(item.reference)}</strong> ‚Äî ${escapeHTML(item.nom)}
                <div class="tiny">Qt√© ${safeInt(item.quantite)} / Stock s√©cu ${safeInt(item.stockSecu)} ‚Ä¢ ${escapeHTML(nameById("machines", item.machineId, "nom", "Sans machine"))}</div>
              </li>
            `).join("")}
          </ul>
        ` : `<div class="dashboardEmpty">Aucune pi√®ce sous le stock de s√©curit√©.</div>`}
      </div>
      <div class="dashboardCard">
        <h3>Tickets en cours</h3>
        ${openTickets.length ? `
          <ul class="dashboardList">
            ${openTickets.map(item => `
              <li>
                <strong>${escapeHTML(item.numero)}</strong> ‚Äî ${escapeHTML(item.sujet)}
                <div class="tiny">${ticketStatutPill(item.statut)} ‚Ä¢ ${escapeHTML(item.demandeur)} ‚Ä¢ ${escapeHTML(nameById("machines", item.machineId, "nom", "Sans machine"))}</div>
              </li>
            `).join("")}
          </ul>
        ` : `<div class="dashboardEmpty">Aucun ticket en cours.</div>`}
      </div>
      <div class="dashboardCard">
        <h3>Interventions planifi√©es (14 jours)</h3>
        ${upcomingInterventions.length ? `
          <ul class="dashboardList">
            ${upcomingInterventions.map(item => `
              <li>
                <strong>${escapeHTML(item.numero)}</strong> ‚Äî ${escapeHTML(item.nom)}
                <div class="tiny">${new Date(item.date).toLocaleString()} ‚Ä¢ ${escapeHTML(item.technicien)} ‚Ä¢ ${escapeHTML(nameById("machines", item.machineId, "nom", "Sans machine"))}</div>
              </li>
            `).join("")}
          </ul>
        ` : `<div class="dashboardEmpty">Aucune intervention planifi√©e dans les 14 prochains jours.</div>`}
      </div>
      <div class="dashboardCard">
        <h3>Machines en r√©paration</h3>
        ${machinesRepair.length ? `
          <ul class="dashboardList">
            ${machinesRepair.map(item => `
              <li>
                <strong>${escapeHTML(item.numeroUnique)}</strong> ‚Äî ${escapeHTML(item.nom)}
                <div class="tiny">${escapeHTML(item.lieu || "Lieu non renseign√©")}</div>
              </li>
            `).join("")}
          </ul>
        ` : `<div class="dashboardEmpty">Aucune machine en r√©paration.</div>`}
      </div>
    </div>
  `;
}

/* ============================
   5) Form builder
============================ */
function renderForm(){
  const cfg = ENTITIES[currentEntity];
  const entityArr = db[currentEntity];
  const existing = editingId ? entityArr.find(x => x.id===editingId) : null;

  const html = [];
  html.push(`<form id="entityForm">`);
  html.push(`<div class="row">`);

  for(const f of cfg.fields){
    if(f.type === "action_create_intervention"){
      html.push(`
        <div class="field" style="flex:1;min-width:220px">
          <label>${f.label}</label>
          <button class="btn primary" type="button" id="btnCreateFromTicket" ${(!editingId ? "disabled": "")}>
            G√©n√©rer intervention
          </button>
          <div class="hint">Actif uniquement en √©dition d‚Äôun ticket.</div>
        </div>
      `);
      continue;
    }

    html.push(`<div class="field">`);
    html.push(`<label>${f.label}${f.required ? " *" : ""}</label>`);

    const val = existing ? (existing[f.key] ?? "") : (f.key.includes("date") ? nowISO() : "");
    if(f.type === "textarea"){
      html.push(`<textarea name="${f.key}" placeholder="${escapeAttr(f.placeholder||"")}">${(val ?? "")}</textarea>`);
    }
    else if(f.type === "select"){
      const opts = (f.options||[]).map(o=>{
        const selected = (val === o.value) ? "selected" : "";
        return `<option value="${escapeAttr(o.value)}" ${selected}>${o.label}</option>`;
      }).join("");
      html.push(`<select name="${f.key}">${opts}</select>`);
    }
    else if(f.type === "select_fournisseur"){
      const opts = [`<option value="">‚Äî</option>`].concat(db.fournisseurs.map(fr=>{
        const selected = (val === fr.id) ? "selected" : "";
        return `<option value="${escapeAttr(fr.id)}" ${selected}>${fr.entreprise} ‚Äì ${fr.nomContact}</option>`;
      }));
      html.push(`<select name="${f.key}">${opts.join("")}</select>`);
    }
    else if(f.type === "select_machine"){
      const opts = [`<option value="">‚Äî</option>`].concat(db.machines.map(m=>{
        const selected = (val === m.id) ? "selected" : "";
        return `<option value="${escapeAttr(m.id)}" ${selected}>${m.numeroUnique} ‚Äì ${m.nom}</option>`;
      }));
      html.push(`<select name="${f.key}">${opts.join("")}</select>`);
    }
    else{
      const type = f.type || "text";
      const valueAttr = (type==="datetime-local") ? `value="${escapeAttr(val)}"` : `value="${escapeAttr(val)}"`;
      html.push(`<input type="${type}" name="${f.key}" placeholder="${escapeAttr(f.placeholder||"")}" ${valueAttr} />`);
    }

    html.push(`</div>`);
  }

  html.push(`</div>`);

  html.push(`
    <div class="row" style="justify-content:flex-end;margin-top:6px">
      ${editingId ? `<button class="btn" type="button" id="btnCancelEdit">Annuler</button>` : ""}
      <button class="btn primary" type="submit">${editingId ? "Enregistrer" : "Cr√©er"}</button>
    </div>
    <div class="hint">* champs requis</div>
  `);

  html.push(`</form>`);
  formArea.innerHTML = html.join("");

  // bind
  const form = document.getElementById("entityForm");
  form.onsubmit = (e)=>{
    e.preventDefault();
    handleSubmit(form);
  };

  const btnCancelEdit = document.getElementById("btnCancelEdit");
  if(btnCancelEdit){
    btnCancelEdit.onclick = ()=>{
      editingId = null;
      render();
    };
  }

  const btnCreateFromTicket = document.getElementById("btnCreateFromTicket");
  if(btnCreateFromTicket){
    btnCreateFromTicket.onclick = ()=>{
      if(currentEntity!=="tickets" || !editingId) return;
      createInterventionFromTicket(editingId);
    };
  }
}

function handleSubmit(form){
  const cfg = ENTITIES[currentEntity];
  const fd = new FormData(form);
  const obj = editingId ? {...db[currentEntity].find(x=>x.id===editingId)} : { id: uid() };

  // validate + assign
  for(const f of cfg.fields){
    if(f.type === "action_create_intervention") continue;
    const raw = fmt(fd.get(f.key));
    let value = raw;

    if(f.type === "number") value = safeInt(raw, 0);
    if(f.type === "datetime-local"){
      // keep as ISO-like local input string
      value = raw || nowISO();
    }

    if(f.required && (value === "" || value === null || value === undefined)){
      toast("Champ requis manquant", f.label);
      return;
    }
    obj[f.key] = value;
  }

  // upsert
  if(editingId){
    const idx = db[currentEntity].findIndex(x=>x.id===editingId);
    if(idx >= 0) db[currentEntity][idx] = obj;
    toast("Modifi√©", `${ENTITIES[currentEntity].label} mise √† jour`);
  }else{
    db[currentEntity].unshift(obj);
    toast("Cr√©√©", `${ENTITIES[currentEntity].label} ajout√©`);
  }

  saveDB();
  editingId = null;
  render();
}

/* ============================
   6) Table renderer
============================ */
function renderTable(){
  const cfg = ENTITIES[currentEntity];
  const query = fmt(searchInput.value).toLowerCase();

  const rows = db[currentEntity]
    .filter(r => {
      if(!query) return true;
      return JSON.stringify(r).toLowerCase().includes(query);
    });

  // header
  thead.innerHTML = `
    <tr>
      ${cfg.columns.map(c=>`<th>${c.label}</th>`).join("")}
      <th style="width:72px">Actions</th>
    </tr>
  `;

  // body
  tbody.innerHTML = rows.map(r=>{
    const tds = cfg.columns.map(c=>{
      const val = r[c.key];
      const cell = c.render ? c.render(val, r) : escapeHTML(val);
      return `<td>${cell}</td>`;
    }).join("");

    return `
      <tr data-id="${escapeAttr(r.id)}" class="rowClick">
        ${tds}
        <td>
          <button class="btn" data-act="edit" title="√âditer">‚úèÔ∏è</button>
          <button class="btn danger" data-act="del" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join("");

  countLabel.textContent = `${rows.length} √©l√©ment(s)`;

  // bind row actions
  tbody.querySelectorAll("tr").forEach(tr=>{
    const id = tr.getAttribute("data-id");
    tr.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(btn){
        const act = btn.getAttribute("data-act");
        if(act==="edit") startEdit(id);
        if(act==="del") delRow(id);
        e.stopPropagation();
        return;
      }
      startEdit(id);
    });
  });
}

function startEdit(id){
  editingId = id;
  render();
}

function delRow(id){
  const cfg = ENTITIES[currentEntity];
  const row = db[currentEntity].find(x=>x.id===id);
  if(!row) return;

  // r√®gles simples pour √©viter de casser les relations
  if(currentEntity==="fournisseurs"){
    const usedInStocks = db.stocks.some(s => s.fournisseurId===id);
    const usedInMachines = db.machines.some(m => m.fournisseurId===id);
    if(usedInStocks || usedInMachines){
      toast("Suppression bloqu√©e", "Ce fournisseur est r√©f√©renc√© (stocks/machines).");
      return;
    }
  }
  if(currentEntity==="machines"){
    const usedInStocks = db.stocks.some(s => s.machineId===id);
    const usedInInterventions = db.interventions.some(i => i.machineId===id);
    const usedInTickets = db.tickets.some(t => t.machineId===id);
    if(usedInStocks || usedInInterventions || usedInTickets){
      toast("Suppression bloqu√©e", "Cette machine est r√©f√©renc√©e (stocks/interventions/tickets).");
      return;
    }
  }

  const label = cfg.label;
  const ok = confirmDanger(`Supprimer cet √©l√©ment de ${label} ?`);
  if(!ok) return;

  db[currentEntity] = db[currentEntity].filter(x=>x.id!==id);

  // si intervention supprim√©e, unlink tickets
  if(currentEntity==="interventions"){
    db.tickets = db.tickets.map(t => t.lienInterventionId===id ? ({...t, lienInterventionId:""}) : t);
  }

  saveDB();
  toast("Supprim√©", `${label} retir√©`);
  if(editingId===id) editingId=null;
  render();
}

function escapeHTML(v){
  const s = (v ?? "").toString();
  return s
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* ============================
   7) Ticket -> Intervention
============================ */
function createInterventionFromTicket(ticketId){
  const t = db.tickets.find(x=>x.id===ticketId);
  if(!t) return;

  if(t.lienInterventionId){
    toast("D√©j√† li√©", "Ce ticket a d√©j√† une intervention associ√©e.");
    return;
  }

  const newIntervention = {
    id: uid(),
    numero: "INT-" + String(1000 + db.interventions.length + 1).slice(-4),
    technicien: "‚Äî",
    nom: `[Ticket ${t.numero}] ${t.sujet}`,
    description: t.description || "",
    date: nowISO(),
    statut: "a_planifier",
    importance: t.importance || "moyen",
    machineId: t.machineId || ""
  };

  db.interventions.unshift(newIntervention);
  t.lienInterventionId = newIntervention.id;
  t.statut = "en_traitement";

  saveDB();
  toast("Intervention cr√©√©e", `${newIntervention.numero} g√©n√©r√©e depuis ${t.numero}`);
  render();
}

/* ============================
   8) Top actions: New / Search / Export / Import / Reset
============================ */
document.getElementById("btnNew").onclick = ()=>{
  editingId = null;
  render();
};

searchInput.addEventListener("input", ()=>{
  renderTable();
  renderKPIs();
});

document.getElementById("btnExport").onclick = ()=>{
  const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `gmao_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("Export JSON", "Fichier t√©l√©charg√©");
};

document.getElementById("importFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const imported = JSON.parse(text);

    // merge/replace simple
    const next = {
      fournisseurs: Array.isArray(imported.fournisseurs) ? imported.fournisseurs : [],
      machines: Array.isArray(imported.machines) ? imported.machines : [],
      stocks: Array.isArray(imported.stocks) ? imported.stocks : [],
      interventions: Array.isArray(imported.interventions) ? imported.interventions : [],
      tickets: Array.isArray(imported.tickets) ? imported.tickets : [],
    };

    db = next;
    saveDB();
    toast("Import JSON", "Donn√©es charg√©es");
    render();
  }catch(err){
    console.error(err);
    toast("Import impossible", "JSON invalide");
  }finally{
    e.target.value = "";
  }
});

document.getElementById("btnReset").onclick = ()=>{
  const ok = confirmDanger("Reset : effacer toutes les donn√©es locales ?");
  if(!ok) return;
  db = defaultDB();
  saveDB();
  editingId = null;
  toast("Reset", "Donn√©es r√©initialis√©es");
  render();
};

/* ============================
   9) Boot
============================ */
initTabs();
render();
</script>

</body>
</html>
